<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant App Login</title>
    <!-- Load Tailwind CSS -->
    <meta http-equiv="Cross-Origin-Opener-Policy" content="restrict-properties">
    <meta http-equiv="Cross-Origin-Embedder-Policy" content="require-corp">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font import and basic styling */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            background-color: #f7f9fb;
        }
        .loading {
            pointer-events: none;
            opacity: 0.7;
        }
        .g_id_signin {
            margin-top: 1.5rem; /* Ensure proper spacing */
        }
    </style>
    <!-- Load Google Identity Services client library -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body class="flex items-center justify-center p-4">

    <div class="w-full max-w-md bg-white p-8 rounded-xl shadow-2xl border border-gray-100">
        <h1 class="text-3xl font-bold text-gray-800 mb-2 text-center">Restaurant App</h1>
        <p class="text-gray-500 mb-6 text-center">Sign in with your Google account to access the restaurant app.</p>

        <!-- Loading overlay -->
        <div id="loading-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white p-4 rounded-lg shadow-xl">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
            </div>
        </div>

        <!-- Google One Tap / Sign-In Container (data-callback is crucial) -->
        <div id="g_id_onload"
             data-client_id="930013363401-1g7t4rqlvanqpjl9sv0hp34u9pnbqtfk.apps.googleusercontent.com"
             data-callback="handleCredentialResponse"
             data-auto_select="false"
             data-prompt_parent_id="g_id_onload"
             data-use_fedcm_for_prompt = "true">
        </div>
        
        <!-- REMINDER: You MUST still ensure the exact URL/Origin where this file is running 
             (e.g., http://localhost:8080 or https://your-domain.com) 
             is added to your Google Cloud Console -> Credentials -> Authorized JavaScript origins list. -->

        <!-- Google Sign-In Button (Standard type is best for multi-account) -->
        <div class="flex justify-center">
            <div class="g_id_signin" 
                 data-type="standard" 
                 data-size="large" 
                 data-theme="outline" 
                 data-text="sign_in_with" 
                 data-shape="pill"
                 data-logo_alignment="left">
            </div>
        </div>
        
        <div class="mt-8" id="auth-status">
            <h2 class="text-lg font-semibold text-gray-700 mb-3 border-b pb-2">Authentication Status</h2>
            <div id="status-message" class="text-gray-500 italic">Not authenticated</div>
            
            <!-- Only show when authenticated -->
            <div id="authenticated-section" class="hidden mt-4">
                <button onclick="redirectToApp()" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors">
                    Continue to App
                </button>
            </div>
        </div>
        
    </div>

    <script>
        // DOM elements
        const statusMessage = document.getElementById('status-message');
        const authenticatedSection = document.getElementById('authenticated-section');
        const loadingOverlay = document.getElementById('loading-overlay');

        // Show/hide loading overlay
        function setLoading(loading) {
            loadingOverlay.classList.toggle('hidden', !loading);
            document.body.classList.toggle('loading', loading);
        }

        /**
         * Helper function to decode the Google ID Token (a JWT).
         * @param {string} token The JWT string.
         * @returns {object} The decoded payload.
         */
        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                // Use built-in decoding if available, otherwise use a safe fallback
                const jsonPayload = decodeURIComponent(
                    atob(base64).split('').map(function(c) {
                        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                    }).join('')
                );
                return JSON.parse(jsonPayload);
            } catch (e) {
                console.error("Failed to parse JWT:", e);
                return null;
            }
        }

        /**
         * Redirect to the main app after successful authentication
         */
        function redirectToApp() {
            // You can modify this to redirect to your main app page
            window.location.href = 'http://127.0.0.1:8000/app';
        }

        /**
         * Shows a notification message to the user
         * @param {string} message - The message to display
         * @param {string} type - The type of message ('success' or 'error')
         */
        function showNotification(message, type = 'success') {
            const container = document.querySelector('.w-full');
            const notification = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-100' : 'bg-red-100';
            const textColor = type === 'success' ? 'text-green-700' : 'text-red-700';
            const borderColor = type === 'success' ? 'border-green-400' : 'border-red-400';
            
            notification.className = `absolute top-0 right-0 mt-4 mr-4 ${bgColor} border ${borderColor} ${textColor} px-4 py-3 rounded-xl shadow-lg transition-opacity duration-300`;
            notification.textContent = message;
            container.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('opacity-0');
                notification.addEventListener('transitionend', () => notification.remove());
            }, 3000);
        }

        /**
         * Handles the response from the Google Sign-In process.
         * This function is the data-callback specified in the g_id_onload div.
         * @param {object} response The credential response object.
         */
        async function handleCredentialResponse(response) {
            console.log("ID Token received");
            
            const userData = parseJwt(response.credential);
            if (!userData || !userData.email) {
                showNotification("Could not extract email from ID Token.", "error");
                return;
            }

            const email = userData.email;
            
            try {
                setLoading(true);
                // First try to login
                let apiResponse = await fetch('http://127.0.0.1:8000/api/v1/customers/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: response.credential })
                });

                // If user doesn't exist, try to sign up
                if (apiResponse.status === 404) {
                    apiResponse = await fetch('http://127.0.0.1:8000/api/v1/customers/signup', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ token: response.credential })
                    });
                }

                if (!apiResponse.ok) {
                    const error = await apiResponse.json();
                    throw new Error(error.detail || 'Authentication failed');
                }

                const data = await apiResponse.json();
                
                // Store the tokens securely
                localStorage.setItem('access_token', data.access_token);
                localStorage.setItem('refresh_token', data.refresh_token);

                // Update UI
                statusMessage.textContent = `Authenticated as: ${email}`;
                authenticatedSection.classList.remove('hidden');
                showNotification(`Successfully authenticated: ${email}`);
                
            } catch (error) {
                console.error('Authentication error:', error);
                showNotification(error.message || 'Authentication failed', 'error');
            } finally {
                setLoading(false);
            }
        }
    </script>
</body>
</html>